<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Photos</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<style>
body {
  margin:0;
  font-family:'Inter',sans-serif;
  background:#000;
  color:#fff;
}
header {
  position:fixed;
  top:0; left:0; right:0;
  height:70px;
  background:#111;
  display:flex; justify-content:space-between; align-items:center;
  padding:0 30px;
  box-shadow:0 2px 10px rgba(255,255,255,0.1);
  z-index:100;
}
header h1 { margin:0; font-size:1.7em; font-weight:600; }
header .auth-buttons button {
  margin-left:10px;
  padding:8px 16px;
  border:none; border-radius:25px;
  cursor:pointer; font-weight:600;
  background:#444; color:#fff;
  transition:0.3s;
}
header .auth-buttons button:hover {
  transform:scale(1.05);
  box-shadow:0 4px 12px rgba(255,255,255,0.2);
}
header .auth-buttons button.google { background:#DB4437; }

#main {
  margin-top:90px;
  padding:20px;
  max-width:1000px;
  margin-left:auto; margin-right:auto;
}
#drop-area {
  width:100%; min-height:160px;
  border:2px dashed #666;
  border-radius:12px;
  display:flex; justify-content:center; align-items:center;
  font-size:1.2em;
  background:#111;
  cursor:pointer;
  margin-bottom:15px;
  transition:0.3s;
}
#drop-area:hover {
  border-color:#fff;
  box-shadow:0 0 10px rgba(255,255,255,0.3);
}
#info { margin-bottom:20px; font-size:0.95em; color:#ccc; }

#gallery-controls {
  margin-bottom:20px;
  display:flex;
  gap:10px;
}
#bulk-open-btn {
  padding:10px 20px;
  background:#0066cc;
  color:#fff;
  border:none;
  border-radius:25px;
  cursor:pointer;
  font-weight:600;
  transition:0.3s;
  display:none;
}
#bulk-open-btn:hover {
  transform:scale(1.05);
  box-shadow:0 4px 12px rgba(0,102,204,0.4);
}

#gallery {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:15px;
}
#gallery .photo-wrapper { position:relative; }
#gallery img {
  width:100%;
  display:block;
  border-radius:12px;
  transition: transform 0.3s, box-shadow 0.3s;
  cursor:pointer;
}
#gallery img:hover {
  transform: scale(1.03);
  box-shadow:0 0 15px rgba(255,255,255,0.3);
}
.delete-btn {
  position:absolute; top:8px; right:8px;
  background:rgba(255,0,0,0.8);
  border:none; border-radius:50%;
  width:25px; height:25px; color:white;
  font-weight:bold; cursor:pointer;
}
.edit-btn {
  position:absolute; top:8px; left:8px;
  background:rgba(0,150,255,0.8);
  border:none; border-radius:50%;
  width:25px; height:25px; color:white;
  font-weight:bold; cursor:pointer;
  font-size:12px;
}
#auth-modal {
  display:none;
  position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.8);
  display:flex; justify-content:center; align-items:center;
  z-index:200;
}
#auth-modal .modal-content {
  background:#222; color:#fff;
  padding:30px; border-radius:16px;
  width:320px; text-align:center;
}
#auth-modal input {
  width:100%; margin-bottom:12px; padding:10px;
  border:1px solid #555; border-radius:8px;
  background:#000; color:#fff;
}
#auth-modal button {
  width:100%; padding:10px;
  border:none; border-radius:25px;
  background:#444; color:white;
  font-weight:600; cursor:pointer;
}
#modal-img {
  display:none;
  position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.9);
  justify-content:center; align-items:center;
  z-index:300; cursor:pointer;
}
#modal-img img {
  max-width:90%; max-height:90%;
  border-radius:12px;
}

/* 編集モーダルのスタイル */
#edit-modal {
  display:none;
  position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.9);
  z-index:400;
}
#edit-modal .edit-container {
  width:100%; height:100%;
  display:flex; flex-direction:column;
  padding:20px; box-sizing:border-box;
}
#edit-modal .edit-header {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:20px; color:white;
}
#edit-modal .edit-controls {
  display:flex; gap:10px; flex-wrap:wrap;
}
#edit-modal .edit-controls button {
  padding:8px 16px;
  background:#444; color:white;
  border:none; border-radius:6px;
  cursor:pointer; font-size:14px;
  transition:0.3s;
}
#edit-modal .edit-controls button:hover {
  background:#666;
}
#edit-modal .edit-controls button.primary {
  background:#0066cc;
}
#edit-modal .edit-controls button.primary:hover {
  background:#0088ff;
}
#edit-modal .crop-container {
  flex:1; display:flex; justify-content:center; align-items:center;
  margin:20px 0;
}
#edit-modal .crop-container img {
  max-width:100%; max-height:100%;
}
</style>
</head>
<body>

<header>
  <h1>My Photos</h1>
  <div class="auth-buttons" id="auth-buttons">
    <button onclick="showLogin()">ログイン</button>
    <button onclick="showSignup()">新規登録</button>
    <button class="google" onclick="loginWithGoogle()">Google</button>
  </div>
</header>

<div id="main">
  <div id="drop-area">ここに画像をドラッグ＆ドロップ、またはクリック</div>
  <input type="file" id="fileElem" multiple style="display:none">
  <div id="info">
    <div id="upload-info">アップロード時間がここに表示されます</div>
    <div id="storage-info">総ストレージ使用量がここに表示されます</div>
  </div>
  
  <div id="gallery-controls">
    <button id="bulk-open-btn" onclick="openAllImagesInTabs()">全ての画像を新しいタブで開く</button>
  </div>
  
  <div id="gallery"></div>
</div>

<div id="auth-modal">
  <div class="modal-content">
    <h2 id="auth-title">ログイン</h2>
    <input type="email" id="email" placeholder="メール">
    <input type="password" id="password" placeholder="パスワード">
    <button id="auth-submit">送信</button>
    <a href="#" onclick="closeAuth()" style="color:#ccc;">閉じる</a>
  </div>
</div>

<div id="modal-img" onclick="this.style.display='none'"><img id="modal-img-inner"></div>

<!-- 編集モーダル -->
<div id="edit-modal">
  <div class="edit-container">
    <div class="edit-header">
      <h2>画像編集</h2>
      <div class="edit-controls">
        <button onclick="cropperRotate(-90)">↶ 左回転</button>
        <button onclick="cropperRotate(90)">↷ 右回転</button>
        <button onclick="cropperFlipX()">⇄ 水平反転</button>
        <button onclick="cropperFlipY()">⇅ 垂直反転</button>
        <button onclick="cropperReset()">リセット</button>
        <button class="primary" onclick="saveEditedImage()">保存</button>
        <button onclick="closeEditModal()">キャンセル</button>
      </div>
    </div>
    <div class="crop-container">
      <img id="edit-image" style="max-width:100%; max-height:100%;">
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBtHs722o6_JWvbgIo5rHuAGEcnNiGqFhg",
    authDomain: "aaaaaa-d2ab0.firebaseapp.com",
    projectId: "aaaaaa-d2ab0",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const dropArea = document.getElementById('drop-area');
const fileElem = document.getElementById('fileElem');
const gallery = document.getElementById('gallery');
const uploadInfo = document.getElementById('upload-info');
const storageInfo = document.getElementById('storage-info');
const bulkOpenBtn = document.getElementById('bulk-open-btn');

// 現在のフォトURLsを保存する配列
let currentPhotoUrls = [];

// Cropper.js関連の変数
let cropper = null;
let currentEditingDocId = null;

function showLogin(){
  document.getElementById('auth-modal').style.display='flex';
  document.getElementById('auth-title').innerText='ログイン';
  document.getElementById('auth-submit').onclick=login;
}
function showSignup(){
  document.getElementById('auth-modal').style.display='flex';
  document.getElementById('auth-title').innerText='新規登録';
  document.getElementById('auth-submit').onclick=signup;
}
function closeAuth(){
  document.getElementById('auth-modal').style.display='none';
}
function signup(){
  const email = document.getElementById('email').value;
  const pw = document.getElementById('password').value;
  auth.createUserWithEmailAndPassword(email, pw)
    .then(()=>{ alert('登録成功'); closeAuth(); })
    .catch(e=>alert(e.message));
}
function login(){
  const email = document.getElementById('email').value;
  const pw = document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email, pw)
    .then(()=>{ alert('ログイン成功'); closeAuth(); })
    .catch(e=>alert(e.message));
}
function loginWithGoogle(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then(r=>{ alert('Googleログイン成功: '+r.user.email); closeAuth(); })
    .catch(e=>alert('Googleログインエラー: '+e.message));
}
function logout(){ auth.signOut(); }

const cloudName = "dqud9tdr8";
const uploadPreset = "annkomoti";

dropArea.addEventListener('click',()=>fileElem.click());
dropArea.addEventListener('dragover', e=>{ e.preventDefault(); dropArea.style.borderColor='#fff'; });
dropArea.addEventListener('dragleave', e=>{ e.preventDefault(); dropArea.style.borderColor='#666'; });
dropArea.addEventListener('drop', e=>{ e.preventDefault(); dropArea.style.borderColor='#666'; handleFiles(e.dataTransfer.files); });
fileElem.addEventListener('change', e=>handleFiles(e.target.files));

async function handleFiles(files){
  if(!files.length) return;
  const user = auth.currentUser;
  if(!user){ alert('ログインしてください'); return; }

  for(let file of files){
    const start = performance.now();
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', uploadPreset);
    formData.append('folder', 'private_photos/' + user.uid);

    try{
      const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, { method:'POST', body:formData });
      const data = await res.json();
      const end = performance.now();
      const uploadTime = ((end-start)/1000).toFixed(2);

      uploadInfo.innerText = `アップロード完了: ${file.name} (${uploadTime}秒)`;

      await db.collection('users').doc(user.uid).collection('photos').add({
        url: data.secure_url,
        size: file.size,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      displayGallery();
    }catch(err){ alert('アップロードエラー: '+err.message); }
  }
}

// 全ての画像を新しいタブで開く機能
function openAllImagesInTabs(){
  if(currentPhotoUrls.length === 0){
    alert('開く画像がありません');
    return;
  }
  
  // ブラウザがポップアップをブロックしないように確認
  if(currentPhotoUrls.length > 10){
    if(!confirm(`${currentPhotoUrls.length}枚の画像を新しいタブで開きます。よろしいですか？`)){
      return;
    }
  }

  // 各画像を新しいタブで開く（少し遅延を入れてブラウザの負荷を軽減）
  currentPhotoUrls.forEach((url, index) => {
    setTimeout(() => {
      window.open(url, '_blank');
    }, index * 100); // 100ms間隔で開く
  });
}

// 画像編集機能
function openEditModal(imageUrl, docId) {
  currentEditingDocId = docId;
  const editImage = document.getElementById('edit-image');
  editImage.src = imageUrl;
  
  document.getElementById('edit-modal').style.display = 'block';
  
  // 画像が読み込まれた後にCropperを初期化
  editImage.onload = function() {
    if (cropper) {
      cropper.destroy();
    }
    cropper = new Cropper(editImage, {
      aspectRatio: NaN, // フリークロップ
      viewMode: 2,
      responsive: true,
      restore: false,
      guides: true,
      center: true,
      highlight: false,
      cropBoxMovable: true,
      cropBoxResizable: true,
      toggleDragModeOnDblclick: false
    });
  };
}

function closeEditModal() {
  document.getElementById('edit-modal').style.display = 'none';
  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
  currentEditingDocId = null;
}

// Cropper操作関数
function cropperRotate(degree) {
  if (cropper) {
    cropper.rotate(degree);
  }
}

function cropperFlipX() {
  if (cropper) {
    const canvasData = cropper.getCanvasData();
    cropper.scaleX(canvasData.scaleX === 1 ? -1 : 1);
  }
}

function cropperFlipY() {
  if (cropper) {
    const canvasData = cropper.getCanvasData();
    cropper.scaleY(canvasData.scaleY === 1 ? -1 : 1);
  }
}

function cropperReset() {
  if (cropper) {
    cropper.reset();
  }
}

// 編集した画像を保存
async function saveEditedImage() {
  if (!cropper || !currentEditingDocId) return;
  
  try {
    // クロップされた画像をCanvasとして取得
    const canvas = cropper.getCroppedCanvas({
      maxWidth: 1920,
      maxHeight: 1920,
      fillColor: '#fff',
      imageSmoothingEnabled: true,
      imageSmoothingQuality: 'high'
    });
    
    // CanvasをBlobに変換
    canvas.toBlob(async (blob) => {
      if (!blob) return;
      
      const user = auth.currentUser;
      if (!user) return;
      
      // 新しい画像をCloudinaryにアップロード
      const formData = new FormData();
      formData.append('file', blob);
      formData.append('upload_preset', uploadPreset);
      formData.append('folder', 'private_photos/' + user.uid);
      
      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, { 
          method: 'POST', 
          body: formData 
        });
        const data = await res.json();
        
        // Firestoreの画像URLを更新
        await db.collection('users').doc(user.uid).collection('photos').doc(currentEditingDocId).update({
          url: data.secure_url,
          editedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        closeEditModal();
        displayGallery();
        alert('画像の編集が完了しました');
        
      } catch (err) {
        alert('保存エラー: ' + err.message);
      }
    }, 'image/jpeg', 0.9);
    
  } catch (err) {
    alert('編集エラー: ' + err.message);
  }

async function displayGallery(){
  gallery.innerHTML = '';
  currentPhotoUrls = []; // URLリストをリセット
  const user = auth.currentUser;
  if(!user) {
    bulkOpenBtn.style.display = 'none';
    return;
  }
  
  const snapshot = await db.collection('users').doc(user.uid).collection('photos').orderBy('createdAt','desc').get();
  let totalSize = 0;

  snapshot.forEach(doc=>{
    const data = doc.data();
    totalSize += data.size ? data.size : 0;
    
    // URLを配列に追加
    currentPhotoUrls.push(data.url);

    const wrapper = document.createElement('div');
    wrapper.className = 'photo-wrapper';

    const img = document.createElement('img');
    img.src = data.url;
    img.onclick = ()=>{ 
      document.getElementById('modal-img-inner').src = data.url; 
      document.getElementById('modal-img').style.display='flex'; 
    };

    const delBtn = document.createElement('button');
    delBtn.innerText='×';
    delBtn.className='delete-btn';
    delBtn.onclick = async (e)=>{
      e.stopPropagation();
      if(!confirm('本当に削除しますか？')) return;
      await db.collection('users').doc(user.uid).collection('photos').doc(doc.id).delete();
      displayGallery();
    };

    const editBtn = document.createElement('button');
    editBtn.innerText='✎';
    editBtn.className='edit-btn';
    editBtn.title='画像を編集';
    editBtn.onclick = (e)=>{
      e.stopPropagation();
      openEditModal(data.url, doc.id);
    };

    wrapper.appendChild(img);
    wrapper.appendChild(editBtn);
    wrapper.appendChild(delBtn);
    gallery.appendChild(wrapper);
  });

  storageInfo.innerText = `総ストレージ使用量: ${(totalSize/1024/1024).toFixed(2)} MB`;
  
  // 画像がある場合のみ一括表示ボタンを表示
  bulkOpenBtn.style.display = currentPhotoUrls.length > 0 ? 'block' : 'none';
}

// 画像編集機能
function openEditModal(imageUrl, docId) {
  currentEditingDocId = docId;
  const editImage = document.getElementById('edit-image');
  editImage.src = imageUrl;
  
  document.getElementById('edit-modal').style.display = 'block';
  
  // 画像が読み込まれた後にCropperを初期化
  editImage.onload = function() {
    if (cropper) {
      cropper.destroy();
    }
    cropper = new Cropper(editImage, {
      aspectRatio: NaN, // フリークロップ
      viewMode: 2,
      responsive: true,
      restore: false,
      guides: true,
      center: true,
      highlight: false,
      cropBoxMovable: true,
      cropBoxResizable: true,
      toggleDragModeOnDblclick: false
    });
  };
}

function closeEditModal() {
  document.getElementById('edit-modal').style.display = 'none';
  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
  currentEditingDocId = null;
}

// Cropper操作関数
function cropperRotate(degree) {
  if (cropper) {
    cropper.rotate(degree);
  }
}

function cropperFlipX() {
  if (cropper) {
    const canvasData = cropper.getCanvasData();
    cropper.scaleX(canvasData.scaleX === 1 ? -1 : 1);
  }
}

function cropperFlipY() {
  if (cropper) {
    const canvasData = cropper.getCanvasData();
    cropper.scaleY(canvasData.scaleY === 1 ? -1 : 1);
  }
}

function cropperReset() {
  if (cropper) {
    cropper.reset();
  }
}

// 編集した画像を保存
async function saveEditedImage() {
  if (!cropper || !currentEditingDocId) return;
  
  try {
    // クロップされた画像をCanvasとして取得
    const canvas = cropper.getCroppedCanvas({
      maxWidth: 1920,
      maxHeight: 1920,
      fillColor: '#fff',
      imageSmoothingEnabled: true,
      imageSmoothingQuality: 'high'
    });
    
    // CanvasをBlobに変換
    canvas.toBlob(async (blob) => {
      if (!blob) return;
      
      const user = auth.currentUser;
      if (!user) return;
      
      // 新しい画像をCloudinaryにアップロード
      const formData = new FormData();
      formData.append('file', blob);
      formData.append('upload_preset', uploadPreset);
      formData.append('folder', 'private_photos/' + user.uid);
      
      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, { 
          method: 'POST', 
          body: formData 
        });
        const data = await res.json();
        
        // Firestoreの画像URLを更新
        await db.collection('users').doc(user.uid).collection('photos').doc(currentEditingDocId).update({
          url: data.secure_url,
          editedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        closeEditModal();
        displayGallery();
        alert('画像の編集が完了しました');
        
      } catch (err) {
        alert('保存エラー: ' + err.message);
      }
    }, 'image/jpeg', 0.9);
    
  } catch (err) {
    alert('編集エラー: ' + err.message);
  }
}

auth.onAuthStateChanged(user=>{
  const authDiv = document.getElementById('auth-buttons');
  if(user){
    authDiv.innerHTML = `${user.email} <button onclick="logout()">ログアウト</button>`;
    displayGallery();
  }else{
    authDiv.innerHTML = `<button onclick="showLogin()">ログイン</button><button onclick="showSignup()">新規登録</button><button class="google" onclick="loginWithGoogle()">Google</button>`;
    gallery.innerHTML = '';
    currentPhotoUrls = [];
    bulkOpenBtn.style.display = 'none';
    uploadInfo.innerText = 'アップロード時間がここに表示されます';
    storageInfo.innerText = '総ストレージ使用量がここに表示されます';
  }
});
</script>
</body>
</html>
